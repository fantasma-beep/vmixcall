<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantasmaLink</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="https://i.ibb.co/9vR9zM8/logo-fantasma-fondo.png" type="image/png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/9vR9zM8/logo-fantasma-fondo.png">
    <meta name="theme-color" content="#1a1a1a">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        #self-view-container {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 25%;
            max-width: 280px;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid #333;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        #self-view-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #main-video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .control-btn {
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            padding: 0.75rem;
            transition: background-color 0.2s;
        }
        .control-btn:hover {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .control-btn.active {
            background-color: #ef4444; /* Rojo para salir */
        }
         .control-btn.sharing {
            background-color: #2563eb; /* Azul para compartir */
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen">

    <!-- Pantalla de Conexión -->
    <div id="connection-screen" class="text-center p-4 max-w-lg mx-auto">
        <img src="LOGOFANTASMA.jpg" alt="Logo de FantasmaCall" class="mx-auto mb-6 w-28 h-28 rounded-full">
        <h1 class="text-3xl font-bold mb-4">Bienvenido a FantasmaLink</h1>
        <p class="text-gray-400 mb-8">Ingresa tu nombre y haz clic en "Unirse" para conectar.</p>
        
        <div id="initial-form">
            <input type="text" id="user-name" placeholder="Tu Nombre" class="w-full max-w-xs px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-center">
            <button id="join-btn" class="w-full max-w-xs px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Unirse a la Llamada</button>
        </div>

        <div id="link-generator" class="hidden">
             <p class="text-lg text-gray-300 mb-4">Copia este enlace para invitar a tu participante:</p>
            <div class="flex items-center justify-center bg-gray-800 p-2 rounded-lg mb-6 max-w-md mx-auto">
                <input type="text" id="invite-link" readonly class="w-full bg-transparent text-md font-mono text-green-400 focus:outline-none" value="Generando enlace...">
                <button id="copy-link-btn" class="ml-4 p-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition" title="Copiar Enlace">
                    <svg class="w-5 h-5" fill="white" viewBox="0 0 20 20"><path d="M7 3a1 1 0 011-1h5a1 1 0 011 1v2h1.5a1.5 1.5 0 011.5 1.5v9a1.5 1.5 0 01-1.5 1.5h-9A1.5 1.5 0 013 15.5v-9A1.5 1.5 0 014.5 5H6V3a1 1 0 011-1zM6 5v1h8V5h-1v1a1 1 0 01-1 1H8a1 1 0 01-1-1V5H6z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Pantalla de la Llamada -->
    <div id="call-screen" class="hidden w-full h-full flex flex-col relative">
        <main id="main-video-container" class="w-full h-full bg-black">
        </main>

        <div id="self-view-container">
        </div>

        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center space-x-4 z-20">
            <button id="mute-btn" class="control-btn" title="Silenciar">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
            </button>
            <button id="video-btn" class="control-btn" title="Detener Video">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            </button>
            <button id="share-screen-btn" class="control-btn" title="Compartir Pantalla">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            </button>
            <button id="settings-btn" class="control-btn" title="Ajustes">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
             <button id="end-call-btn" class="control-btn active" title="Salir">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path></svg>
            </button>
        </div>
    </div>
    
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg text-left shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Ajustes</h2>
            
            <h3 class="text-lg font-semibold mb-2">Fuente de Video</h3>
            <select id="video-source-select" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none mb-4"></select>

            <h3 class="text-lg font-semibold mb-2">Ancho de Banda (Calidad)</h3>
            <select id="bandwidth-select" class="w-full px-3 py-2 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none mb-4">
                <option value="2500000">Alta (2.5 Mbps)</option>
                <option value="1000000" selected>Media (1 Mbps)</option>
                <option value="300000">Baja (300 Kbps)</option>
            </select>

            <h3 class="text-lg font-semibold mb-2">Salida de Audio</h3>
            <div id="audio-output-list" class="flex flex-col space-y-2 mb-4"></div>

            <button id="close-settings-btn" class="w-full mt-4 px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">Cerrar</button>
        </div>
    </div>

    <script>
        const connectionScreen = document.getElementById('connection-screen');
        const callScreen = document.getElementById('call-screen');
        const joinBtn = document.getElementById('join-btn');
        const userNameInput = document.getElementById('user-name');
        const initialForm = document.getElementById('initial-form');
        const linkGenerator = document.getElementById('link-generator');
        const inviteLinkInput = document.getElementById('invite-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const mainVideoContainer = document.getElementById('main-video-container');
        const selfViewContainer = document.getElementById('self-view-container');
        const muteBtn = document.getElementById('mute-btn');
        const videoBtn = document.getElementById('video-btn');
        const endCallBtn = document.getElementById('end-call-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const audioOutputList = document.getElementById('audio-output-list');
        const videoSourceSelect = document.getElementById('video-source-select');
        const bandwidthSelect = document.getElementById('bandwidth-select');
        const shareScreenBtn = document.getElementById('share-screen-btn');

        let peer;
        let localStream;
        let myName = `Invitado-${Math.floor(Math.random() * 1000)}`;
        let hostId;
        let activeCall;
        let originalVideoTrack = null;

        const startApp = async () => {
            myName = userNameInput.value || myName;
            
            try {
                await setupLocalMedia();
                
                await populateAudioOutputs();
                await populateVideoInputs();
                
                initializePeer();
            } catch (err) {
                console.error("Error al acceder a la cámara/micrófono:", err);
                alert("No se pudo acceder a tu cámara y micrófono. Revisa los permisos.");
            }
        };

        const initializePeer = () => {
            const urlParams = new URLSearchParams(window.location.search);
            hostId = urlParams.get('room');

            peer = new Peer();

            peer.on('open', (id) => {
                if (hostId) {
                    const call = peer.call(hostId, localStream);
                    handleCall(call);
                    showCallScreen();
                } else {
                    const newUrl = `${window.location.origin}${window.location.pathname}?room=${id}`;
                    inviteLinkInput.value = newUrl;
                    initialForm.classList.add('hidden');
                    linkGenerator.classList.remove('hidden');
                }
            });

            peer.on('call', (call) => {
                call.answer(localStream);
                handleCall(call);
                showCallScreen();
            });
        };

        const handleCall = (call) => {
            activeCall = call;
             call.on('stream', (remoteStream) => {
                const mainVideo = document.createElement('video');
                mainVideo.srcObject = remoteStream;
                mainVideo.autoplay = true;
                mainVideo.playsInline = true;
                mainVideoContainer.innerHTML = '';
                mainVideoContainer.append(mainVideo);
            });
        };

        const setupLocalMedia = async (deviceId = undefined) => {
            const constraints = {
                video: { deviceId: deviceId ? { exact: deviceId } : undefined },
                audio: true,
            };
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            const selfVideo = document.createElement('video');
            selfVideo.srcObject = localStream;
            selfVideo.muted = true;
            selfVideo.autoplay = true;
            selfVideo.playsInline = true;
            selfViewContainer.innerHTML = '';
            selfViewContainer.append(selfVideo);
        };

        const populateAudioOutputs = async () => { /* ... (sin cambios) ... */ };
        const setAudioOutput = async (deviceId) => { /* ... (sin cambios) ... */ };

        const populateVideoInputs = async () => {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoInputs = devices.filter(d => d.kind === 'videoinput');
            videoSourceSelect.innerHTML = '';
            videoInputs.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Cámara ${index + 1}`;
                videoSourceSelect.appendChild(option);
            });
        };
        
        const changeVideoSource = async (deviceId) => {
            const newStream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } }, audio: false });
            const newTrack = newStream.getVideoTracks()[0];
            replaceTrack(newTrack);
        };
        
        const changeBandwidth = (bitrate) => {
            if (activeCall) {
                const sender = activeCall.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                if (sender) {
                    const parameters = sender.getParameters();
                    if (!parameters.encodings) parameters.encodings = [{}];
                    parameters.encodings[0].maxBitrate = parseInt(bitrate, 10);
                    sender.setParameters(parameters)
                        .then(() => alert(`Calidad de video ajustada.`))
                        .catch(e => console.error('Error al ajustar ancho de banda', e));
                }
            }
        };

        const toggleScreenSharing = async () => {
            if (originalVideoTrack) {
                // Dejar de compartir
                const screenTrack = localStream.getVideoTracks()[0];
                screenTrack.stop();
                replaceTrack(originalVideoTrack);
                originalVideoTrack = null;
                shareScreenBtn.classList.remove('sharing');
                shareScreenBtn.title = "Compartir Pantalla";
            } else {
                // Empezar a compartir
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const screenTrack = screenStream.getVideoTracks()[0];
                originalVideoTrack = localStream.getVideoTracks()[0];
                replaceTrack(screenTrack);
                
                screenTrack.onended = () => {
                    if (originalVideoTrack) {
                         toggleScreenSharing();
                    }
                };
                shareScreenBtn.classList.add('sharing');
                shareScreenBtn.title = "Dejar de Compartir";
            }
        };
        
        const replaceTrack = (newTrack) => {
            // Reemplazar en el stream local
            const oldTrack = localStream.getVideoTracks()[0];
            localStream.removeTrack(oldTrack);
            localStream.addTrack(newTrack);
            selfViewContainer.querySelector('video').srcObject = localStream;
            
            // Reemplazar en la conexión activa
            if(activeCall){
                const sender = activeCall.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                if (sender) sender.replaceTrack(newTrack);
            }
        };

        const showCallScreen = () => {
            connectionScreen.classList.add('hidden');
            callScreen.classList.remove('hidden');
        };

        joinBtn.addEventListener('click', startApp);
        copyLinkBtn.addEventListener('click', () => {
            inviteLinkInput.select();
            document.execCommand('copy');
            alert('¡Enlace de invitación copiado!');
        });
        muteBtn.addEventListener('click', () => { /* ... (sin cambios) ... */ });
        videoBtn.addEventListener('click', () => { /* ... (sin cambios) ... */ });
        endCallBtn.addEventListener('click', () => window.location.reload());
        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        videoSourceSelect.addEventListener('change', (e) => changeVideoSource(e.target.value));
        bandwidthSelect.addEventListener('change', (e) => changeBandwidth(e.target.value));
        shareScreenBtn.addEventListener('click', toggleScreenSharing);

    </script>
</body>
</html>

